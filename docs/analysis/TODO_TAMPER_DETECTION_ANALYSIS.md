# TODO.md Tamper Detection Analysis

**Task:** #210.1
**Date:** 2026-01-25
**Status:** Analysis Complete

## Executive Summary

TODO.md currently has a **passive warning system** but **no active enforcement** or detection mechanism for manual edits. While basic modification time tracking exists, there are no checksums, signatures, or warnings when tampering is detected.

---

## Current State

### 1. Existing Integrity Mechanisms

#### 1.1 Passive Warning Header
- **Location:** Header of TODO.md, generated by FileOps
- **Implementation:** `todo_ai/core/file_ops.py:667`
- **Content:**
  ```markdown
  > ‚ö†Ô∏è **MANAGED FILE**: Do not edit manually. Use `todo-ai` (CLI/MCP) or `todo.ai` to manage tasks.
  ```
- **Effectiveness:** **None** - purely informational, no enforcement
- **Coverage:** Visible in file, documentation, and tests

#### 1.2 File Modification Time (mtime) Tracking
- **Location:** `todo_ai/core/file_ops.py:97-102`
- **Mechanism:**
  - Captures `_snapshot_mtime` when first reading file
  - Compares `current_mtime` on subsequent reads
  - Invalidates and recaptures structure snapshot if `current_mtime > _snapshot_mtime`
- **Behavior:** **Silent recapture** - no warning or notification
- **Code:**
  ```python
  current_mtime = self.todo_path.stat().st_mtime
  if self._structure_snapshot is None or current_mtime > self._snapshot_mtime:
      self._structure_snapshot = self._capture_structure_snapshot()
      self._snapshot_mtime = current_mtime
  ```

#### 1.3 Pre-commit Hook (todo-ai lint)
- **Location:** `.pre-commit-config.yaml:70-78`
- **Trigger:** On commit, if TODO.md is staged
- **Command:** `uv run python -m todo_ai.cli.main lint`
- **Checks:**
  - Spacing violations (blank lines between root tasks)
  - Indentation issues
  - Orphaned subtasks
  - Duplicate task IDs
  - Malformed checkboxes
- **Limitations:**
  - Only runs on commit
  - Only detects formatting violations, not content tampering
  - Can be bypassed with `--no-verify`

#### 1.4 CI/CD Validation
- **Location:** `.github/workflows/ci-cd.yml`
- **Checks:** TODO.md integrity verification in CI pipeline
- **Limitations:**
  - Only runs on push to remote
  - Post-facto detection (damage already committed)

### 2. What Is NOT Detected

#### 2.1 Manual Content Edits
- ‚ùå Task description changes
- ‚ùå Tag additions/removals
- ‚ùå Note modifications
- ‚ùå Status changes ([ ] to [x])
- ‚ùå Task deletions
- ‚ùå Task ID tampering

#### 2.2 Structural Tampering
- ‚ùå Section reordering (Tasks, Archived, Deleted)
- ‚ùå Header/footer removal or modification
- ‚ùå Separator line changes

#### 2.3 Metadata Corruption
- ‚ùå Timestamp manipulation
- ‚ùå Tool variant forgery in footer
- ‚ùå Version number tampering

---

## Vulnerabilities

### 1. **Complete Absence of Content Verification**

**Risk Level:** üî¥ Critical

**Description:** No checksums, hashes, or signatures verify file content integrity.

**Attack Scenarios:**
1. **Agent Confusion Attack:**
   - Manual edit: Change task #42 description from "Fix bug" to "Delete production database"
   - Agent reads file, sees modified description
   - No warning issued, agent proceeds with corrupted data

2. **Status Manipulation:**
   - Manual edit: Mark incomplete task as `[x]` complete
   - Agent/user believes task is done
   - Work remains incomplete, causing project delays

3. **ID Collision:**
   - Manual edit: Duplicate task ID #50
   - System integrity compromised
   - Potential data loss on next write operation

### 2. **Silent Snapshot Recapture**

**Risk Level:** üü° Medium

**Description:** When FileOps detects mtime change, it silently recaptures the snapshot with no user notification.

**Implications:**
- User/agent unaware that file was modified externally
- Corrupted data becomes "new baseline"
- No opportunity to review or rollback changes

### 3. **Pre-commit Hook Bypass**

**Risk Level:** üü° Medium

**Description:** Pre-commit hooks can be bypassed with `git commit --no-verify`.

**Attack Scenarios:**
1. Malicious/careless user commits manually edited TODO.md
2. Formatting violations pass through to repository
3. Other team members pull corrupted data

### 4. **No Runtime Warnings in MCP/CLI**

**Risk Level:** üü† High

**Description:** When todo-ai commands read TODO.md, no warnings are issued if tampering is suspected.

**User Experience Impact:**
- Silent corruption acceptance
- No feedback loop for accidental edits
- Difficult to diagnose data inconsistencies

### 5. **Limited Edit Attribution**

**Risk Level:** üü° Medium

**Description:** While `.todo.ai/.todo.ai.log` captures *what* changed (Action, User, Task ID), it lacks context on *how* the change was made (Interface: Shell, CLI, MCP).

**Current State:**
- Logs exist: `TIMESTAMP | USER | ACTION | TASK_ID | DESCRIPTION`
- Missing context: No distinction between `./todo.ai` (Shell), `todo-ai` (CLI), or MCP tool usage.
- Gap: Cannot easily trace if an edit came from an automated agent (MCP) or manual CLI usage.

**Implications:**
- Harder to debug agent behavior vs user actions.
- "Manual" edits (text editor) leave no log trace at all (this remains a gap).

---

## Current Detection Capabilities

### What CAN Be Detected (with existing linter)

| Issue | Detection Method | Severity |
|-------|-----------------|----------|
| Spacing violations | Lint command | Low |
| Indentation errors | Lint command | Low |
| Duplicate task IDs | Lint command | High |
| Orphaned subtasks | Lint command | Medium |
| Malformed checkboxes | Lint command | Low |

### What CANNOT Be Detected

| Issue | Current State | Impact |
|-------|---------------|--------|
| Content tampering | ‚ùå No detection | Critical |
| Task description edits | ‚ùå No detection | High |
| Tag manipulation | ‚ùå No detection | Medium |
| Note modifications | ‚ùå No detection | Medium |
| Timestamp forgery | ‚ùå No detection | Medium |
| Status changes | ‚ùå No detection | High |
| Manual task additions/deletions | ‚ùå No detection | Critical |

---

## Threat Model

### Threat Actors

1. **AI Agent Bypass (Primary Threat)**
   - **Probability:** üî¥ Critical
   - **Intent:** Benevolent but destructive. Agents often bypass the MCP server/CLI to perform "quick fixes" using primitive file editing tools.
   - **Impact:** High data destruction risk. Agents may delete sections, corrupt formatting, or hallucinate task states when editing raw text.
   - **Example:** Agent uses `sed` or `write_file` to modify a task, accidentally deleting the "Archived" section or corrupting the header.

2. **Accidental User Edit**
   - **Probability:** High
   - **Intent:** No malicious intent, just mistakes.
   - **Example:** User opens TODO.md in editor, accidentally saves changes or resolves a merge conflict incorrectly.

3. **Malicious Tampering**
   - **Probability:** Low
   - **Intent:** Deliberate corruption or sabotage.
   - **Example:** Disgruntled contributor manipulates task data.

### Failure Modes

1. **Data Corruption Without Detection**
   - Manual edit corrupts TODO.md
   - No warning issued
   - Corruption propagates to all users via Git

2. **Agent Confusion**
   - Agent reads corrupted file
   - Acts on incorrect information
   - Amplifies damage through automated actions

3. **Loss of Trust**
   - Users discover tampering post-facto
   - Loss of confidence in todo-ai system
   - Migration to alternative tools

---

## Research Findings (Task #210.2)

### 1. Hashing Strategy
- **Algorithm:** SHA-256 is the industry standard for file integrity. It is fast, secure, and widely supported in Python's `hashlib`.
- **Normalization:** To ensure cross-platform consistency (Windows CRLF vs Unix LF), file content **MUST** be normalized before hashing.
  - **Recommendation:** Read file as text, normalize newlines to `\n`, encode to UTF-8, then hash.
  - **Why:** Prevents false positives when a file is checked out on Windows but was committed on Linux.

### 2. Storage Location
- **Option A:** `.todo.ai/checksum` (Plain text file containing hash)
  - Pros: Simple, easy to debug, atomic writes.
  - Cons: Another file to manage.
- **Option B:** Inside `.todo.ai/config.toml` or similar
  - Pros: Consolidated config.
  - Cons: Parsing overhead, risk of config corruption during write.
- **Recommendation:** **Option A (`.todo.ai/checksum`)**. It isolates the integrity mechanism from configuration. If the checksum file is missing/corrupt, it's a clear signal of tampering or fresh install.

### 3. Verification Workflow
1. **Read:** `FileOps` reads `TODO.md`.
2. **Hash:** Calculate SHA-256 of current content (normalized).
3. **Compare:** Read stored hash from `.todo.ai/checksum`.
4. **Result:**
   - **Match:** Proceed normally.
   - **Mismatch:** Raise `TamperError`.
   - **Missing Checksum:** Treat as first run or "unverified state" (warn user, generate new hash).

### 4. User Experience & Recovery
When `TamperError` occurs, the CLI/MCP must handle it gracefully.
- **CLI Prompt:**
  ```text
  ‚ö†Ô∏è  External modification detected in TODO.md!
  The file matches neither the last known state nor the expected format.

  [A]ccept changes (Update checksum to match current file)
  [D]iff (Show changes vs last known state - requires keeping a backup)
  [C]ancel (Abort command)
  ```
- **MCP Behavior:**
  - Since MCP is often headless/agent-driven, it should probably **fail with a clear error message** requiring human intervention or a specific "force" flag to proceed. Agents should not blindly accept tampering.

### 5. Performance Impact
- **Hashing:** SHA-256 on a 1MB file (approx 20k lines of text) takes < 5ms in Python.
- **I/O:** One extra small file read (`.todo.ai/checksum`).
- **Conclusion:** Negligible performance impact.

---

## Recommendations

### Immediate Actions (High Priority)

1. **Add Warning on mtime Mismatch**
   - Detect external modification via mtime
   - Issue prominent warning to user/agent
   - Provide options: (a) Continue, (b) Review diff, (c) Abort

2. **Implement Checksum Verification**
   - Store SHA-256 hash of TODO.md in `.todo.ai/checksum`
   - Verify on each read operation
   - Alert on mismatch

3. **Add `--force` Flag for Manual Edits**
   - Require explicit acknowledgment for external edits
   - Log acceptance in `.todo.ai/.todo.ai.log`

### Medium-Term Actions

1. **Content Diffing on Detection**
   - Show user/agent what changed since last known-good state
   - Highlight suspicious changes (ID modifications, status flips)

2. **Tamper-Evident Logging**
   - **Enhance `.todo.ai.log`:** Add "Interface" column (Shell/CLI/MCP) to track *source* of changes.
   - **Log External Edits:** When "Force" is used or external edit accepted, log it explicitly in `.todo.ai.log`.
   - **Forensics:** Enable better auditing of Agent vs Human actions.

3. **Recovery Mechanism**
   - Store snapshots of known-good states
   - Enable rollback on corruption detection

### Long-Term Actions

1. **Cryptographic Signatures**
   - Sign TODO.md with tool signature
   - Verify signature on read
   - Strongest integrity guarantee

2. **Git Integration**
   - Detect uncommitted changes
   - Warn if TODO.md modified outside of todo-ai workflow
   - Suggest commit/revert actions

---

## Implementation Priorities

| Feature | Priority | Effort | Impact |
|---------|----------|--------|--------|
| Warning on external edit | üî¥ Critical | Low | High |
| Checksum verification | üî¥ Critical | Low | High |
| Diff display | üü† High | Medium | High |
| Tamper log | üü° Medium | Low | Medium |
| Recovery mechanism | üü° Medium | High | Medium |
| Cryptographic signatures | üü¢ Low | High | High |

---

## Conclusion

TODO.md is currently **vulnerable to undetected tampering**. While the system has basic structural preservation (FileStructureSnapshot) and formatting validation (lint), it lacks **active content integrity verification** and **user warnings**.

**Next Steps:**
1. Proceed to **task #210.2** (Research best practices) - **COMPLETED**
2. Design solution based on this analysis (**task #210.3**)
3. Implement detection and warning system (**task #210.4**)

---

**Analysis completed:** 2026-01-25
**Analyst:** AI Agent via Cursor
**Task:** #210.1 (Analyze current TODO.md integrity checks and vulnerability to manual edits)
