# TODO.md Tamper Detection Analysis

**Task:** #210.1
**Date:** 2026-01-25
**Status:** Analysis Complete

## Executive Summary

TODO.md currently has a **passive warning system** but **no active enforcement** or detection mechanism for manual edits. While basic modification time tracking exists, there are no checksums, signatures, or warnings when tampering is detected.

---

## Current State

### 1. Existing Integrity Mechanisms

#### 1.1 Passive Warning Header
- **Location:** Header of TODO.md, generated by FileOps
- **Implementation:** `todo_ai/core/file_ops.py:667`
- **Content:**
  ```markdown
  > ‚ö†Ô∏è **MANAGED FILE**: Do not edit manually. Use `todo-ai` (CLI/MCP) or `todo.ai` to manage tasks.
  ```
- **Effectiveness:** **None** - purely informational, no enforcement
- **Coverage:** Visible in file, documentation, and tests

#### 1.2 File Modification Time (mtime) Tracking
- **Location:** `todo_ai/core/file_ops.py:97-102`
- **Mechanism:**
  - Captures `_snapshot_mtime` when first reading file
  - Compares `current_mtime` on subsequent reads
  - Invalidates and recaptures structure snapshot if `current_mtime > _snapshot_mtime`
- **Behavior:** **Silent recapture** - no warning or notification
- **Code:**
  ```python
  current_mtime = self.todo_path.stat().st_mtime
  if self._structure_snapshot is None or current_mtime > self._snapshot_mtime:
      self._structure_snapshot = self._capture_structure_snapshot()
      self._snapshot_mtime = current_mtime
  ```

#### 1.3 Pre-commit Hook (todo-ai lint)
- **Location:** `.pre-commit-config.yaml:70-78`
- **Trigger:** On commit, if TODO.md is staged
- **Command:** `uv run python -m todo_ai.cli.main lint`
- **Checks:**
  - Spacing violations (blank lines between root tasks)
  - Indentation issues
  - Orphaned subtasks
  - Duplicate task IDs
  - Malformed checkboxes
- **Limitations:**
  - Only runs on commit
  - Only detects formatting violations, not content tampering
  - Can be bypassed with `--no-verify`

#### 1.4 CI/CD Validation
- **Location:** `.github/workflows/ci-cd.yml`
- **Checks:** TODO.md integrity verification in CI pipeline
- **Limitations:**
  - Only runs on push to remote
  - Post-facto detection (damage already committed)

### 2. What Is NOT Detected

#### 2.1 Manual Content Edits
- ‚ùå Task description changes
- ‚ùå Tag additions/removals
- ‚ùå Note modifications
- ‚ùå Status changes ([ ] to [x])
- ‚ùå Task deletions
- ‚ùå Task ID tampering

#### 2.2 Structural Tampering
- ‚ùå Section reordering (Tasks, Archived, Deleted)
- ‚ùå Header/footer removal or modification
- ‚ùå Separator line changes

#### 2.3 Metadata Corruption
- ‚ùå Timestamp manipulation
- ‚ùå Tool variant forgery in footer
- ‚ùå Version number tampering

---

## Vulnerabilities

### 1. **Complete Absence of Content Verification**

**Risk Level:** üî¥ Critical

**Description:** No checksums, hashes, or signatures verify file content integrity.

**Attack Scenarios:**
1. **Agent Confusion Attack:**
   - Manual edit: Change task #42 description from "Fix bug" to "Delete production database"
   - Agent reads file, sees modified description
   - No warning issued, agent proceeds with corrupted data

2. **Status Manipulation:**
   - Manual edit: Mark incomplete task as `[x]` complete
   - Agent/user believes task is done
   - Work remains incomplete, causing project delays

3. **ID Collision:**
   - Manual edit: Duplicate task ID #50
   - System integrity compromised
   - Potential data loss on next write operation

### 2. **Silent Snapshot Recapture**

**Risk Level:** üü° Medium

**Description:** When FileOps detects mtime change, it silently recaptures the snapshot with no user notification.

**Implications:**
- User/agent unaware that file was modified externally
- Corrupted data becomes "new baseline"
- No opportunity to review or rollback changes

### 3. **Pre-commit Hook Bypass**

**Risk Level:** üü° Medium

**Description:** Pre-commit hooks can be bypassed with `git commit --no-verify`.

**Attack Scenarios:**
1. Malicious/careless user commits manually edited TODO.md
2. Formatting violations pass through to repository
3. Other team members pull corrupted data

### 4. **No Runtime Warnings in MCP/CLI**

**Risk Level:** üü† High

**Description:** When todo-ai commands read TODO.md, no warnings are issued if tampering is suspected.

**User Experience Impact:**
- Silent corruption acceptance
- No feedback loop for accidental edits
- Difficult to diagnose data inconsistencies

### 5. **Lack of Edit Attribution**

**Risk Level:** üü° Medium

**Description:** No tracking of WHO made changes or WHEN they were made outside of Git.

**Implications:**
- Cannot determine if edit was intentional vs accidental
- No audit trail for debugging
- Difficult to identify source of corruption

---

## Current Detection Capabilities

### What CAN Be Detected (with existing linter)

| Issue | Detection Method | Severity |
|-------|-----------------|----------|
| Spacing violations | Lint command | Low |
| Indentation errors | Lint command | Low |
| Duplicate task IDs | Lint command | High |
| Orphaned subtasks | Lint command | Medium |
| Malformed checkboxes | Lint command | Low |

### What CANNOT Be Detected

| Issue | Current State | Impact |
|-------|---------------|--------|
| Content tampering | ‚ùå No detection | Critical |
| Task description edits | ‚ùå No detection | High |
| Tag manipulation | ‚ùå No detection | Medium |
| Note modifications | ‚ùå No detection | Medium |
| Timestamp forgery | ‚ùå No detection | Medium |
| Status changes | ‚ùå No detection | High |
| Manual task additions/deletions | ‚ùå No detection | Critical |

---

## Threat Model

### Threat Actors

1. **Accidental User Edit**
   - Probability: High
   - Intent: No malicious intent, just mistakes
   - Example: User opens TODO.md in editor, accidentally saves changes

2. **Agent Bypass**
   - Probability: Medium
   - Intent: Agent tries to work around todo-ai limitations
   - Example: Agent directly edits file to "fix" perceived issue

3. **Malicious Tampering**
   - Probability: Low
   - Intent: Deliberate corruption or sabotage
   - Example: Disgruntled contributor manipulates task data

### Failure Modes

1. **Data Corruption Without Detection**
   - Manual edit corrupts TODO.md
   - No warning issued
   - Corruption propagates to all users via Git

2. **Agent Confusion**
   - Agent reads corrupted file
   - Acts on incorrect information
   - Amplifies damage through automated actions

3. **Loss of Trust**
   - Users discover tampering post-facto
   - Loss of confidence in todo-ai system
   - Migration to alternative tools

---

## Recommendations

### Immediate Actions (High Priority)

1. **Add Warning on mtime Mismatch**
   - Detect external modification via mtime
   - Issue prominent warning to user/agent
   - Provide options: (a) Continue, (b) Review diff, (c) Abort

2. **Implement Checksum Verification**
   - Store SHA-256 hash of TODO.md in `.todo.ai/`
   - Verify on each read operation
   - Alert on mismatch

3. **Add `--force` Flag for Manual Edits**
   - Require explicit acknowledgment for external edits
   - Log acceptance in `.todo.ai/.todo.ai.log`

### Medium-Term Actions

1. **Content Diffing on Detection**
   - Show user/agent what changed since last known-good state
   - Highlight suspicious changes (ID modifications, status flips)

2. **Tamper-Evident Logging**
   - Log all file modifications with timestamps
   - Track operations vs external edits
   - Enable forensic analysis

3. **Recovery Mechanism**
   - Store snapshots of known-good states
   - Enable rollback on corruption detection

### Long-Term Actions

1. **Cryptographic Signatures**
   - Sign TODO.md with tool signature
   - Verify signature on read
   - Strongest integrity guarantee

2. **Git Integration**
   - Detect uncommitted changes
   - Warn if TODO.md modified outside of todo-ai workflow
   - Suggest commit/revert actions

---

## Implementation Priorities

| Feature | Priority | Effort | Impact |
|---------|----------|--------|--------|
| Warning on external edit | üî¥ Critical | Low | High |
| Checksum verification | üî¥ Critical | Low | High |
| Diff display | üü† High | Medium | High |
| Tamper log | üü° Medium | Low | Medium |
| Recovery mechanism | üü° Medium | High | Medium |
| Cryptographic signatures | üü¢ Low | High | High |

---

## Conclusion

TODO.md is currently **vulnerable to undetected tampering**. While the system has basic structural preservation (FileStructureSnapshot) and formatting validation (lint), it lacks **active content integrity verification** and **user warnings**.

**Next Steps:**
1. Proceed to **task #210.2** (Research best practices)
2. Design solution based on this analysis (**task #210.3**)
3. Implement detection and warning system (**task #210.4**)

---

**Analysis completed:** 2026-01-25
**Analyst:** AI Agent via Cursor
**Task:** #210.1 (Analyze current TODO.md integrity checks and vulnerability to manual edits)
